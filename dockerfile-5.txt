# Stage 1: Builder Stage
FROM python:3.9 AS builder

# Set build-time argument for the Git repository
ARG REPO_URL=https://github.com/amitopenwriteup/cicdproject.git

# Set environment variables
ENV WORKDIR=/app

# Set the working directory in the container
WORKDIR $WORKDIR

# Install git and other necessary packages
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Clone the repository
RUN git clone --depth=1 $REPO_URL /tmp/repo

# Copy only the 'app' folder and 'requirements.txt' from the cloned repo
RUN cp -r /tmp/repo/app $WORKDIR
RUN cp /tmp/repo/requirements.txt $WORKDIR/requirements.txt

# Remove the cloned repo to free space
RUN rm -rf /tmp/repo

# Install dependencies in a temporary directory to reduce image size
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt


# Stage 2: Final Image
FROM python:3.9

# Set environment variables
ENV WORKDIR=/app
ENV PYTHONUNBUFFERED=1

# Set the working directory in the container
WORKDIR $WORKDIR

# Create a non-root user and group
RUN groupadd --gid 1001 appuser && \
    useradd --uid 1001 --gid appuser --shell /bin/bash --create-home appuser

# Change ownership of the application directory
RUN chown -R appuser:appuser $WORKDIR

# Copy installed dependencies from the builder stage
COPY --from=builder /install /usr/local

# Copy application source code
COPY --from=builder /app /app

# Set up a volume for the application directory
VOLUME ["/app"]

# Expose application port
EXPOSE 5000

# Switch to non-root user
USER appuser

# Command to run the application
CMD ["python", "app/app.py"]
